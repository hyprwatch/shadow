# Hyprwatch Shadow Testing Environment
# Spins up multiple shadow agents across different Linux distributions
#
# Usage:
#   # First, build the shared builder image (one time, or after code changes):
#   docker build -t shadow-builder -f testing/Containerfile.builder .
#
#   # Then start shadows:
#   docker compose up -d                    # Start all (2 of each distro = 8 total)
#   docker compose up -d --scale ubuntu=5   # Start 5 Ubuntu instances
#   docker compose logs -f                  # Follow logs
#   docker compose down                     # Stop and remove all

services:
  ubuntu:
    build:
      context: ..
      dockerfile: testing/Containerfile.ubuntu
    environment:
      - SHADOW_ORG_TOKEN=${SHADOW_ORG_TOKEN:?SHADOW_ORG_TOKEN is required}
      # - SHADOW_SERVER_HOST=localhost:4001
      # - SHADOW_CA_CERT=/certs/selfsigned.pem
      - SHADOW_HOST_IDENTIFIER=instance
    volumes:
      - ../../../server/priv/cert/selfsigned.pem:/certs/selfsigned.pem:ro
    network_mode: host
    deploy:
      replicas: 2
    restart: "no"

  fedora:
    build:
      context: ..
      dockerfile: testing/Containerfile.fedora
    environment:
      - SHADOW_ORG_TOKEN=${SHADOW_ORG_TOKEN:?SHADOW_ORG_TOKEN is required}
      # - SHADOW_SERVER_HOST=localhost:4001
      # - SHADOW_CA_CERT=/certs/selfsigned.pem
      - SHADOW_HOST_IDENTIFIER=instance
    volumes:
      - ../../../server/priv/cert/selfsigned.pem:/certs/selfsigned.pem:ro
    network_mode: host
    deploy:
      replicas: 2
    restart: "no"

  debian:
    build:
      context: ..
      dockerfile: testing/Containerfile.debian
    environment:
      - SHADOW_ORG_TOKEN=${SHADOW_ORG_TOKEN:?SHADOW_ORG_TOKEN is required}
      # - SHADOW_SERVER_HOST=localhost:4001
      # - SHADOW_CA_CERT=/certs/selfsigned.pem
      - SHADOW_HOST_IDENTIFIER=instance
    volumes:
      - ../../../server/priv/cert/selfsigned.pem:/certs/selfsigned.pem:ro
    network_mode: host
    deploy:
      replicas: 2
    restart: "no"

  rocky:
    build:
      context: ..
      dockerfile: testing/Containerfile.rocky
    environment:
      - SHADOW_ORG_TOKEN=${SHADOW_ORG_TOKEN:?SHADOW_ORG_TOKEN is required}
      # - SHADOW_SERVER_HOST=localhost:4001
      # - SHADOW_CA_CERT=/certs/selfsigned.pem
      - SHADOW_HOST_IDENTIFIER=instance
    volumes:
      - ../../../server/priv/cert/selfsigned.pem:/certs/selfsigned.pem:ro
    network_mode: host
    deploy:
      replicas: 2
    restart: "no"
